@model  NVOCShipping.Models.MasterModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>


<script type="text/javascript">

    LayoutApp.controller('MyController', function ($scope, $http, $timeout) {
        $scope.HDArrayIndex = "";
    
        $scope.StatusValues = [

            { 'Name': 'Active', 'ID': 1 },
            { 'Name': 'InActive', 'ID': 2 },

        ];
        $scope.Country = null;
        $scope.fillCountry = function () {
            $http({
                method: 'POST',
                url: '/api/CommonAccessApi/CountryMaster/',
                data: {}
            }).then(function (result) {
                $timeout(function () {
                    $scope.Country = result.data;

                });
            }, function (result) {
                if (result.status == 500) {
                    ShowPopup("Sorry no internet connectivity Application Error.");
                }
                else if (result.status == 404) {
                    ShowPopup("Sorry no internet connectivity page not found.");
                }
                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            }).catch(function (result) {
                ShowPopup('There has been an error: ' + result);
            });

        };
        $scope.fillCountry();


       $scope.TaxNames = null;
       $scope.fillTaxNames = function  () {
            var Datavalue = {};
         //alert($("#ddlCountry").val());
            Datavalue.ID = localStorage.getItem("CountryID");
            $http({
                method: 'POST',
                url: '/api/FinanceApi/BindTaxNames/',
                data: JSON.stringify(Datavalue),
            }).then(function (result) {

                $timeout(function () {
                    
                    $scope.TaxNames = result.data;

                });

            }, function (result) {

                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected. Please reconnect and try again.");
                }
            });

        };
       $scope.fillTaxNames();

        $scope.TaxGLCodes = null;
        $scope.fillTaxGLCodes = function () {
            $http({
                method: 'POST',
                url: '/api/FinanceApi/TaxGLTypes/',
                data: {}
            }).then(function (result) {
                $timeout(function () {
                    $scope.TaxGLCodes = result.data;

                });
            }, function (result) {
                if (result.status == 500) {
                    ShowPopup("Sorry no internet connectivity Application Error.");
                }
                else if (result.status == 404) {
                    ShowPopup("Sorry no internet connectivity page not found.");
                }
                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            }).catch(function (result) {
                ShowPopup('There has been an error: ' + result);
            });

        };
        $scope.fillTaxGLCodes();

        $("#ddlTaxCode").change(function () {
            var Datavalue = {};
             Datavalue.ID = $("#ddlTaxCode").val();

            $http({
                method: 'POST',
                url: "/api/FinanceApi/BindTaxDescByTaxName",
                data: JSON.stringify(Datavalue),
            }).then(function (result) {

                $timeout(function () {
                    //alert(result.data[0].TaxDescription);
                    $scope.TaxDescription = result.data[0].TaxDescription;

                });

            }, function (result) {

                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected. Please reconnect and try again.");
                }
            });
        });

        $(document).ready(function () {

            var queryString = new Array();
            if (window.location.search.split('?').length > 1) {
                var secret_key = CryptoJS.enc.Utf8.parse(localStorage.getItem("SessionKey"));
                var iv = CryptoJS.enc.Utf8.parse(localStorage.getItem("Sessioniv"));
                var bytes = CryptoJS.AES.decrypt(window.location.search.split('?')[1].toString(), secret_key, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });

                var params = bytes.toString(CryptoJS.enc.Utf8).split('&');
                //alert(params);
                for (var i = 0; i < params.length; i++) {
                    var key = params[i].split('=')[0];
                    var value = decodeURIComponent(params[i].split('=')[1]);
                    queryString[key] = value;

                }
            }
            if (queryString["TaxDeclID"] != null) {
               
                $scope.HDTaxDeclId = queryString["TaxDeclID"].toString();
                $scope.BindTaxDeclaration(queryString["TaxDeclID"].toString());
                $scope.BindTaxDeclDtls(queryString["TaxDeclID"].toString());
            }


        });


        $scope.BindTaxDeclaration = function (TaxDeclID) {
            var Datavalue = {};
            Datavalue.ID = TaxDeclID;
            //alert(Datavalue.AgencyID);
            $http({
                method: 'POST',
                url: "/api/FinanceApi/ViewTaxDeclDtls",
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $timeout(function () {
                    if (Datavalue.ID != "" || Datavalue.ID != null) {
                       // alert(result.data[0].TaxName);
                        $scope.txtTaxName = result.data[0].TaxName;
                        $scope.txtTaxPerc = result.data[0].TaxPercentage;
                        $scope.ddlCountry = { ID: result.data[0].CountryID };
                        $scope.ddlStatus = { ID: result.data[0].StatusID };
                    }
                    else {
                        $scope.txtTaxPerc = "";
                        $scope.ddlCountry = 0;
                        $scope.ddlStatus = 0;
                    }
                });
            }, function (result) {

                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected. Please reconnect and try again.");
                }
            });

        }

        $scope.BindTaxDeclDtls = function (TaxDeclID) {
            var Datavalue = {};
            Datavalue.ID = TaxDeclID;

            $http({
                method: 'POST',
                url: "/api/FinanceApi/BindGridTaxDeclDtls",
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $scope.DynamicGrid = [{ TID: "", TaxCodeID: "", TaxCode: "", TaxDescription: "", Percentage: "", TaxGLID: "" , TaxGL: "" }];

                $timeout(function () {

                    if (result.data[0].TaxCodeID != "") {
                        $scope.DynamicGrid.splice(0, 1);
                    }

                    angular.forEach(result.data, function (value, key) {

                        $scope.DynamicGrid.push({
                            'TID': result.data[key].TID,
                            'TaxCodeID': result.data[key].TaxCodeID,
                            'TaxCode': result.data[key].TaxCode,
                            'TaxDescription': result.data[key].TaxDescription,
                            'Percentage': result.data[key].Percentage,
                            'TaxGLID': result.data[key].TaxGLID,
                            'TaxGL': result.data[key].TaxGL,
                        });

                    });
                });
            }, function (result) {

                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            });
        }

        ///----Table add delete remove select-----//
        $scope.DynamicGrid = [{ TID: "", TaxCodeID: "", TaxCode: "", TaxDescription: "", Percentage: "", TaxGLID: "", TaxGL: ""}];

        $scope.DynamicGrid.splice(0, 1);

        $scope.Selectvalues = function (DynamicGrid, index) {
            $scope.HDArrayIndex = index;
            $scope.TID = $scope.DynamicGrid[index].TID;
            $scope.TaxCode = { ID: $scope.DynamicGrid[index].TaxCodeID };
            $scope.TaxDescription = $scope.DynamicGrid[index].TaxDescription;
            $scope.Percentage = $scope.DynamicGrid[index].Percentage;
            $scope.TaxGL = { ID: $scope.DynamicGrid[index].TaxGLID };
         
        }
        $scope.AddTaxDetails = function (DynamicGrid) {

            var validation = "";
            var ddlTaxcode = $('#ddlTaxcode').val();
            if (ddlTaxcode == "?") {

              validation += "<span style='color:red;'>*</span> <span>Please Select Tax Code</span></br>"

            }

            var txtTaxDesc = $('#txtTaxDesc').val();
            if (txtTaxDesc.length == 0) {

                validation += "<span style='color:red;'>*</span> <span>Please Enter Tax Description</span></br>"

            }
            var txtPercentage = $('#txtPercentage').val();
            if (txtPercentage.length == 0) {

                validation += "<span style='color:red;'>*</span> <span>Please Enter Percentage</span></br>"

            }
            var ddlTaxGL = $('#ddlTaxGL').val();
            if (ddlTaxGL == "?") {

                validation += "<span style='color:red;'>*</span> <span>Please Select Tax GL</span></br>"

            }
            if (validation != "") {
                ShowPopup(validation);
                return false;
            }


            var TIDValue;

            TIDValue = ($scope.TID == "") ? 0 : $scope.TID;

            var val = {
                'TID': TIDValue,
                'TaxCodeID': $("#ddlTaxCode").val(),
                'TaxCode': $("#ddlTaxCode option:selected").text(),
                'TaxDescription': $scope.TaxDescription,
                'Percentage': $scope.Percentage,
                'TaxGLID': $("#ddlTaxGL").val(),
                'TaxGL': $("#ddlTaxGL option:selected").text(),


            };
            if ($scope.HDArrayIndex != null && $scope.HDArrayIndex.length != 0) {

                $scope.DynamicGrid[$scope.HDArrayIndex] = val;
            } else {

                $scope.DynamicGrid.push(val);
            }
            $("#ddlTaxCode").val(0).trigger("change");
            $scope.TaxDescription = "";
            $scope.Percentage = "";
            $("#ddlTaxGL").val(0).trigger("change");
            $scope.HDArrayIndex = "";
            $scope.TID = 0;

        }
        //$scope.Remove = function (DynamicGrid, index) {
        //    $scope.DynamicGrid.splice(index, 1);
        //}

     
        $scope.SaveTaxDeclaration = function (data){
            var validation = "";
            var txtTaxPerc = $('#txtTaxPerc').val();
            if (txtTaxPerc.length == 0) {

                validation += "<span style='color:red;'>*</span> <span>Please Enter Tax Percentage</span></br>"

            }
            var ddlCountry = $('#ddlCountry').val();
            if (ddlCountry == "?") {

                validation += "<span style='color:red;'>*</span> <span>Please Select Country</span></br>"
            }
            var ddlStatus = $('#ddlStatus').val();
            if (ddlStatus == "?") {

                validation += "<span style='color:red;'>*</span> <span>Please Select Status</span></br>"
            }
          
            if (validation != "") {

                ShowPopup(validation);
                return false;
            }
            $('#overlay').fadeIn().delay(100).fadeOut();
            var BussData = {}

            var id = $scope.HDTaxDeclId;

            if (id == "" || id == null)
                BussData.ID = 0;
            else
                BussData.ID = $scope.HDTaxDeclId;


            BussData.TaxName = $scope.txtTaxName;
            BussData.TaxPercentage = $scope.txtTaxPerc;
            BussData.CountryID = $('#ddlCountry').val();
            BussData.StatusID = $('#ddlStatus').val();
            var Items = []

            angular.forEach(data, function (value, key) {
                var intTID = data[key].TID;
                if (typeof data[key].TID == "undefined") {
                    intTID = 0;
                }

                Items.push('Insert:' + intTID, data[key].TaxCodeID, data[key].TaxCode, data[key].TaxDescription, data[key].Percentage, data[key].TaxGLID, data[key].TaxGL
                );
            });

            BussData.Itemsv = Items.toString();
            console.log(Items);

            $http({
                method: 'POST',
                url: "/api/FinanceApi/InsertChargeTaxDecl",
                data: JSON.stringify(BussData),
            }).then(function (result) {
                $timeout(function () {
                    $scope.HDTaxDeclId = result.data[0].ID;
                    //$scope.BindTaxDeclaration($scope.HdTaxDeclID);
                    
                    if (result.data[0].ID != "") {
                        //$scope.BindTaxDeclDtls($scope.HdTaxDeclID);
                        ShowPopup("TaxDeclaration Saved Successfully");
                    }
                    else {

                        ShowPopup("Error Not saved");
                    }
                   
                    setTimeOut(function () {
                        window.location = "/";
                    }, 3000);
                });
            }, function (result) {
                if (result.status == 500) {
                    ShowPopup("Sorry no internet connectivity Application Error.");
                }
                else if (result.status == 404) {
                    ShowPopup("Sorry no internet connectivity page not found.");
                }


                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    // $(".modal").hide();
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            }).catch(function (result) {
                // This is set in the event of an error.
                console.log(result);
                ShowPopup('There has been an error: ' + result);
            });
        }

       

        $scope.back = function () {

            window.location = "/Finance/TaxDeclarationView";
        }
    });

    function ShowPopup(message) {
        swal(message);
    };

</script>

<div ng-app="MyApp" ng-controller="MyController">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12 backbtn" style="text-align:right;">
                <button type="submit" ng-click="back();" class="btn btn-fill btn-success btn-round btntop">
                    <i class="material-icons">reply</i> Back

                </button>
                @*<button type="submit" ng-click="AddNew();" class="btn btn-fill btn-success btn-round btntop">
                    <i class="material-icons">reply</i>

                </button>*@

            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card ">
                    <div class="card-header card-header-primary card-header-text">
                        <div class="card-text">
                            <h4 class="card-title">Tax Declaration</h4>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row" style="border:1px solid #ccc;">
                            <div class="col-md-12" style="border:1px solid #ccc;">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label>Tax Name <span class="man">*</span></label>
                                                    <input type="text" autocomplete="off" id="txtTaxName" ng-model="txtTaxName" class="form-control">


                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label>Tax Percentage(%) <span class="man">*</span></label>
                                                    <input type="text" autocomplete="off" id="txtTaxPerc" ng-model="txtTaxPerc" class="form-control">


                                                </div>

                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label>Country <span class="man">*</span></label>
                                                    <select class="form-control my-select" ng-model="ddlCountry" id="ddlCountry" ng-options="item.CountryName for item in Country track by item.ID" required></select>

                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label> Status<span class="man">*</span> </label>


                                                    <select class="form-control my-select" ng-model="ddlStatus" id="ddlStatus" ng-options="item.Name for item in StatusValues track by item.ID" required></select>

                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label>Tax Code</label>
                                                    <input type="hidden" id="HDIDv" class="form-control" ng-model="TID" />
                                                    <input type="hidden" id="HDArrayIndex" class="form-control" ng-model="HDArrayIndex" />
                                                    <select class="form-control" ng-model="TaxCode" id="ddlTaxCode" ng-options="item.TaxCode for item in TaxNames track by item.ID" required></select>

                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-5">
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label>Tax Description</label>
                                                    <input type="text" autocomplete="off" id="txtTaxDesc" ng-model="TaxDescription" class="form-control">

                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label>Percentage(%) </label>

                                                    <input type="text" id="txtPercentage" autocomplete="off" ng-model="Percentage" class="form-control">

                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="form-group">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <label> Tax GL</label>
                                                    <select class="form-control" ng-model="TaxGL" id="ddlTaxGL" ng-options="item.GLCode for item in TaxGLCodes track by item.ID" required></select>


                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-1">
                                       
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <button type="submit" class="btn btn-fill btn-success" ng-click="AddTaxDetails(gRow);" style="padding: 9px 12px; margin:33px 1px; ">
                                                        <i class="material-icons">save</i>
                                                        ADD
                                                    </button>
                                                </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        @*style="border-bottom:1px dashed #000; padding-bottom:10px;"*@
                                        <div class="material-datatables">

                                            <table class="table table-striped table-no-bordered table-hover" cellspacing="0" width="100%" style="width:100%">
                                                <thead class="gridhead1">
                                                    <tr>
                                                        <th>S.No</th>
                                                        <th>Tax Code</th>
                                                        <th>Tax Description</th>
                                                        <th> Percentage(%)</th>
                                                        <th> Tax GL</th>

                                                        <th class="disabled-sorting text-right actwid">Action</th>
                                                    </tr>
                                                </thead>

                                                <tbody>
                                                    <tr class="gridbody1" ng-repeat="gRow in DynamicGrid">


                                                        <td>{{$index+1}}</td>

                                                        <td>
                                                            {{gRow.TaxCode}}

                                                        </td>

                                                        <td>
                                                            {{gRow.TaxDescription}}
                                                        </td>

                                                        <td>
                                                            {{gRow.Percentage}}
                                                        </td>
                                                        <td>
                                                            {{gRow.TaxGL}}

                                                            <input type="hidden" id="HDDTaxGLID" class="form-control" ng-model="gRow.TaxGLID" />
                                                        </td>
                                                        <td class="td-actions text-right bindgrid">

                                                            <button type="button" rel="tooltip" ng-click="Selectvalues(DynamicGrid,$index)" class="btn btn-success btn-round" data-original-title="" title="">
                                                                <i class="material-icons">edit</i>
                                                            </button>

                                                            <input type="hidden" id="HDID" class="form-control" ng-model="gRow.TID" />
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-12" style="border:1px solid #ccc;text-align:right;">
                                <button type="submit" class="btn btn-fill btn-success" ng-click="SaveTaxDeclaration(DynamicGrid);" style="padding: 9px 19px;">

                                    <i class="material-icons">save</i>
                                    Save
                                </button>
                                <input type="hidden" id="HDTaxDeclId" name="HDTaxDeclId" />
                            </div>

                        </div>


                    </div>
                </div>

            </div>

        </div>
   
    </div>
</div>
<script>
    $(document).ready(function () {
        // initialise Datetimepicker and Sliders
        $('.datepicker').datetimepicker({
            format: 'DD/MM/YYYY',

        });
    });
    $(document).ready(function () {
        $('.my-select').select2({
            placeholder: "--Select--",
            allowClear: true,
            width: '100%'
        });
    });
</script>



