@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.full.min.js"></script>
<script type="text/javascript">

    LayoutApp.controller('MyController', function ($scope, $http, $timeout) {
        $scope.HDArrayIndex = "";
        $(document).ready(function () {
            $('.my-select').select2({
                placeholder: "--Select--",
                allowClear: true,
                width: '100%'
            });

        });

        $scope.LocationsMaster = null;
        $scope.filLocationsMaster = function () {
            var Datavalue = {};
            $http({
                method: 'POST',
                url: '/api/Home/GeoLocationsMaster/',
                data: {},
            }).then(function (result) {
                $timeout(function () {
                    $scope.LocationsMaster = result.data;
                });
            }, function (result) {
                if (result.status == 500) {
                    ShowPopup("Sorry no internet connectivity Application Error.");
                }
                else if (result.status == 404) {
                    ShowPopup("Sorry no internet connectivity page not found.");
                }
                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            }).catch(function (result) {
                ShowPopup('There has been an error: ' + result);
            });
        };
        $scope.filLocationsMaster();

        $("#ddlGatePort").change(function () {
            $scope.AgencyList = null;
            var Datavalue = {};
            Datavalue.ID = $("#ddlGatePort").val();
            $http({
                method: 'POST',
                url: '/api/Home/AgencyMasterByGeoLoc/',
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $timeout(function () {
                    $scope.AgencyValues = result.data;
                });
            }, function (result) {
                if (result.status == 500) {
                    ShowPopup("Sorry no internet connectivity Application Error.");
                }
                else if (result.status == 404) {
                    ShowPopup("Sorry no internet connectivity page not found.");
                }
                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            }).catch(function (result) {
                ShowPopup('There has been an error: ' + result);
            });
        });

        $("#ddlAgency").change(function () {

            var Datavalue = {};
            Datavalue.AgencyID = $("#ddlAgency").val();
            $http({
                method: 'POST',
                url: '/api/Home/VesVoyMasterByAgency/',
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $timeout(function () {
                    $scope.VesVoy = result.data;
                });
            }, function (result) {
                if (result.status == 500) {
                    ShowPopup("Sorry no internet connectivity Application Error.");
                }
                else if (result.status == 404) {
                    ShowPopup("Sorry no internet connectivity page not found.");
                }
                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            }).catch(function (result) {
                ShowPopup('There has been an error: ' + result);
            });
        })

        $("#ddlVoyage").change(function ()
        {
            var Datavalue = {};
            Datavalue.ID = $("#ddlVoyage").val();

            $http({
                method: 'POST',
                url: '/api/VoyageGateWay/VoyageETD/',
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $timeout(function () {
                    document.getElementById('txtETD').value = result.data[0].ETD;
                    $scope.functionBooking();
                });
            }, function (result) {
                if (result.status == 500) {
                    ShowPopup("Sorry no internet connectivity Application Error.");
                }
                else if (result.status == 404) {
                    ShowPopup("Sorry no internet connectivity page not found.");
                }
                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            }).catch(function (result) {
                ShowPopup('There has been an error: ' + result);
            });
            
        })


        $(document).ready(function () {

            var queryString = new Array();
            if (window.location.search.split('?').length > 1) {
                var secret_key = CryptoJS.enc.Utf8.parse(localStorage.getItem("SessionKey"));
                var iv = CryptoJS.enc.Utf8.parse(localStorage.getItem("Sessioniv"));
                var bytes = CryptoJS.AES.decrypt(window.location.search.split('?')[1].toString(), secret_key, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });

                var params = bytes.toString(CryptoJS.enc.Utf8).split('&');
                //alert(params);
                for (var i = 0; i < params.length; i++) {
                    var key = params[i].split('=')[0];
                    var value = decodeURIComponent(params[i].split('=')[1]);
                    queryString[key] = value;

                }
            }
            if (queryString["GetWayID"] != null) {
                $scope.HdVoyId = queryString["GetWayID"].toString();
                $scope.BindVoyageDtls(queryString["GetWayID"].toString());
                //$scope.BindBLCntrDtls(queryString["VoyageID"].toString());
                $scope.BindBLCntrDtlsGrid2(queryString["GetWayID"].toString());
            }
        });

        $scope.BindVoyageDtls = function (GetWayID) {

            var Datavalue = {};
            Datavalue.ID = GetWayID;

            $http({
                method: 'POST',
                url: "/api/VoyageGateWay/ExisBkgValuedisplayMain",
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $timeout(function () {

                    if (result.data.length > 0) {

                        $scope.ddlGatePort = { ID: result.data[0].GeoLocation};
                        $('#txtETD').val(result.data[0].ETD);
                        $scope.AgencyList = null;
                        var Datavalue = {};
                        Datavalue.ID = result.data[0].GeoLocation;
                        $http({
                            method: 'POST',
                            url: '/api/Home/AgencyMasterByGeoLoc/',
                            data: JSON.stringify(Datavalue),
                        }).then(function (result) {
                            $timeout(function () {
                                $scope.AgencyValues = result.data;
                            });
                        });
                        var Datavalue = {};
                        Datavalue.AgencyID = $("#ddlAgency").val();
                        $http({
                            method: 'POST',
                            url: '/api/Home/VesVoyMasterByAgency/',
                            data: JSON.stringify(Datavalue),
                        }).then(function (result) {
                            $timeout(function () {
                                $scope.VesVoy = result.data;
                                console.log($scope.VesVoy);
                            });
                        });
                        alert(result.data[0].VoyageID);
                        $scope.ddlAgency = { ID: result.data[0].AgencyID };
                      
                        
                        //$scope.txtStatus = result.data[0].StatusV;

                        if (result.data[0].StatusV == "Locked") {

                            ////document.getElementById("IsVisbleGrid2").style.display = "block";
                            ////document.getElementById("IsVisbleGrid1").style.display = "none";
                            ////document.getElementById("BtnLock").style.display = "none";

                        }
                        else {
                            //document.getElementById("IsVisbleGrid2").style.display = "none";
                            //document.getElementById("IsVisbleGrid1").style.display = "block";
                            //document.getElementById("BtnLock").style.display = "block";

                        }
                        $scope.ddlVoyage = { ID: result.data[0].VoyageID };
                    }


                });
            }, function (result) {

                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            });
        }

        $scope.BindBLCntrDtls = function (VoyageID) {

            var Datavalue = {};
            Datavalue.ID = VoyageID;

            $http({
                method: 'POST',
                url: "/api/Home/VoyageLockingBLDetails",
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $timeout(function () {

                    if (result.data.length > 0) {

                        $scope.DynamicGridBLDetails = result.data;
                    }
                    if (result.data.length == 0) {

                        document.getElementById("BtnLock").style.display = "none";
                    }

                });
            }, function (result) {

                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            });
        }

        $scope.BindBLCntrDtlsGrid2 = function (VoyageID) {

            var Datavalue = {};
            Datavalue.ID = VoyageID;
            $http({
                method: 'POST',
                url: "/api/VoyageGateWay/ExisBkgValuedisplay",
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $timeout(function () {

                    if (result.data.length > 0) {
                        $scope.DynamicGridBLDetails = result.data;
                    }


                });
            }, function (result) {

                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            });
        }

        $scope.back = function () {
            window.location = "/VesVoy/GatewayVoyageView";
        }
      


        $scope.functionBooking = function () {

            var Datavalue = {};
            Datavalue.ID = $("#ddlVoyage").val();
            Datavalue.AgencyID = localStorage.getItem("AgencyID");
            $http({
                method: 'POST',
                url: '/api/VoyageGateWay/BookingValuedisplay/',
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $scope.DynamicGridBLDetails = result.data;
            }, function (result) {
                if (result.status == 500) {
                    ShowPopup("Sorry no internet connectivity Application Error.");
                }
                else if (result.status == 404) {
                    ShowPopup("Sorry no internet connectivity page not found.");
                }
                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            }).catch(function (result) {
                ShowPopup('There has been an error: ' + result);
            });
        }

        $scope.btnVoyagLinked = function (data) {

            var Datavalue = {};
            Datavalue.GeoLocID = $("#ddlGatePort").val();
            Datavalue.AgencyID = $("#ddlAgency").val();
            Datavalue.Voyage = $("#ddlVoyage").val();
            Datavalue.VoyageNo = $("#ddlVoyage option:selected").text();
            Datavalue.ICDAgencyID = localStorage.getItem("AgencyID");
            Datavalue.ETD = $("#txtETD").val();
            var Items = []
            angular.forEach(data, function (value, key)
            {
                if (data[key].ChkFlag == true) {
                    Items.push('Insert:' + data[key].ID);
                }
            });
            Datavalue.Itemsv = Items.toString();

            $http({
                method: 'POST',
                url: "/api/VoyageGateWay/insertGateway_VoyageBL",
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                if (result.data.length > 0) {

                    ShowPopup(result.data[0].AlertMessage);
                }
            }, function (result) {

                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            });
        }


      
        
    });

    function ShowPopup(message) {
        swal(message);
    };


</script>
<div ng-app="MyApp" ng-controller="MyController">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12 backbtn" style="text-align:right;">
                <button type="submit" ng-click="back();" class="btn btn-fill btn-success btn-round btntop">
                    <i class="material-icons">reply</i> Back

                </button>
                @*<button type="submit" ng-click="AddNew();" class="btn btn-fill btn-warning btn-round btntop">
                        <i class="material-icons">edit</i>

                    </button>*@
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card ">
                    <div class="card-header card-header-primary card-header-text">
                        <div class="card-text">
                            <h4 class="card-title"> Gateway Voyage Link</h4>
                        </div>
                    </div>
                    <div class="card-body ">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label>Gateway Port</label>
                                            <select id="ddlGatePort" ng-model="ddlGatePort" class="form-control my-select" ng-options="item.GeoLocation for item in LocationsMaster track by item.ID"></select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label>Agency</label>
                                            <select id="ddlAgency" ng-model="ddlAgency" class="form-control my-select" ng-options="item.AgencyName for item in AgencyValues track by item.ID"></select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label>Voyage</label>
                                            <select id="ddlVoyage" ng-model="ddlVoyage" class="form-control my-select" ng-options="item.VesVoy for item in VesVoy track by item.ID"></select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="lable-fond">ETD</label>
                                            <input type="date" id="txtETD" ng-model="txtETD" class="form-control" />
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="lable-fond">Status</label>
                                            <input disabled type="text" id="txtStatus" ng-model="txtStatus" class="form-control" />
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>

                   <div class="row">
                        <div class="col-md-12">
                            <div class="col-md-12">
                                <h4 style="color: #12759a;font-size:14px;font-weight:bold;"></h4>
                            </div>
                            <div class="col-md-12">


                                <div class="material-datatables"  style="border: 1px solid #ccc; padding: 5px; overflow:scroll;height:200px;">

                                    <table class="table table-striped table-no-bordered table-hover" cellspacing="0" width="100%" style="width:100%">


                                        <thead>
                                            <tr>
                                                <th><input type="checkbox" ng-change="CheckBoxHeadChecked(BLHDCheck);" ng-true-value="1" ng-false-value="0" ng-model="BLHDCheck" id="BLHDCheck" />  </th>
                                                <th>Booking Number</th>
                                                <th>Booking Party</th>
                                                <th>POL</th>
                                                <th>POD</th>
                                                <th>T/S PORT</th>

                                            </tr>
                                        </thead>
                                        <tbody>

                                            <tr ng-repeat="gRow in DynamicGridBLDetails">
                                                <td> <input ng-change="CheckBoxValid(gRow.DynamicGridBLDetails);" type="checkbox" id="ChkFlag" value="{{gRow.ID}}" ng-model="gRow.ChkFlag" ng-true-value="1" ng-false-value="0" /></td>

                                                <td>{{gRow.BLNumber}}</td>
                                                <td>{{gRow.BkgParty}}</td>
                                                <td>{{gRow.POL}}</td>
                                                <td>{{gRow.POD}}</td>
                                                <td>{{gRow.TSPort}}</td>
                                            </tr>


                                        </tbody>
                                    </table>


                                </div>
                              

                            </div>
                        </div>
                    </div>

                    <div class="card-footer ">
                        <div class="col-md-12" style="text-align:right;">
                            <button type="submit" id="BtnLock" ng-click="btnVoyagLinked(DynamicGridBLDetails);" class="btn btn-fill btn-success">Link</button>
                            <input type="hidden" id="HdVoyId" ng-model="HdVoyId" />
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
  </div>