@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.full.min.js"></script>
<script type="text/javascript">

    LayoutApp.controller('MyController', function ($scope, $http, $timeout) {
        $scope.HDArrayIndex = "";
        $(document).ready(function () {
            $('.my-select').select2({
                placeholder: "--Select--",
                allowClear: true,
                width: '100%'
            });

        });

        //Vesvoy DropDown//

        $scope.VesVoy = null;
        $scope.fillVesVoy = function () {
            var Datavalue = {};
            Datavalue.AgencyID = localStorage.getItem("AgencyID");
            $http({
                method: 'POST',
                url: '/api/Home/VesVoyMasterByAgency/',
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $timeout(function () {
                    $scope.VesVoy = result.data;
                });
            }, function (result) {
                if (result.status == 500) {
                    ShowPopup("Sorry no internet connectivity Application Error.");
                }
                else if (result.status == 404) {
                    ShowPopup("Sorry no internet connectivity page not found.");
                }
                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            }).catch(function (result) {
                ShowPopup('There has been an error: ' + result);
            });
        };
        $scope.fillVesVoy();


        $(document).ready(function () {

            var queryString = new Array();
            if (window.location.search.split('?').length > 1) {
                var secret_key = CryptoJS.enc.Utf8.parse(localStorage.getItem("SessionKey"));
                var iv = CryptoJS.enc.Utf8.parse(localStorage.getItem("Sessioniv"));
                var bytes = CryptoJS.AES.decrypt(window.location.search.split('?')[1].toString(), secret_key, {
                    iv: iv,
                    mode: CryptoJS.mode.CBC,
                    padding: CryptoJS.pad.Pkcs7
                });

                var params = bytes.toString(CryptoJS.enc.Utf8).split('&');
                //alert(params);
                for (var i = 0; i < params.length; i++) {
                    var key = params[i].split('=')[0];
                    var value = decodeURIComponent(params[i].split('=')[1]);
                    queryString[key] = value;

                }
            }
            if (queryString["VoyageID"] != null)
            {
                $scope.HdVoyId = queryString["VoyageID"].toString();
                $scope.BindVoyageDtls(queryString["VoyageID"].toString());
                $scope.BindBLCntrDtls(queryString["VoyageID"].toString());
                $scope.BindBLCntrDtlsGrid2(queryString["VoyageID"].toString());
            }
        });

        $scope.BindVoyageDtls = function (VoyageID) {
            var Datavalue = {};
            Datavalue.ID = VoyageID;

            $http({
                method: 'POST',
                url: "/api/Home/VoyageLockingDetailsEdit",
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $timeout(function () {

                    if (result.data.length > 0) {

                        $scope.ddlVoyage = { ID: result.data[0].ID };
                        $('#txtETD').val(result.data[0].ETD);
                        $scope.txtStatus = result.data[0].StatusV;

                        if (result.data[0].StatusV == "Locked") {

                            ////document.getElementById("IsVisbleGrid2").style.display = "block";
                            ////document.getElementById("IsVisbleGrid1").style.display = "none";
                            ////document.getElementById("BtnLock").style.display = "none";

                        }
                        else {
                            //document.getElementById("IsVisbleGrid2").style.display = "none";
                            //document.getElementById("IsVisbleGrid1").style.display = "block";
                            //document.getElementById("BtnLock").style.display = "block";

                        }
                    }


                });
            }, function (result) {

                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            });
        }

        $scope.BindBLCntrDtls = function (VoyageID) {

            var Datavalue = {};
            Datavalue.ID = VoyageID;

            $http({
                method: 'POST',
                url: "/api/Home/VoyageLockingBLDetails",
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $timeout(function () {

                    if (result.data.length > 0) {

                        $scope.DynamicGridBLDetails = result.data;
                    }
                    if (result.data.length == 0) {

                       // document.getElementById("BtnLock").style.display = "none";
                    }

                });
            }, function (result) {

                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            });
        }

        $scope.BindBLCntrDtlsGrid2 = function (VoyageID) {

            var Datavalue = {};
            Datavalue.ID = VoyageID;

            $http({
                method: 'POST',
                url: "/api/Home/VoyageLockedBLDetails",
                data: JSON.stringify(Datavalue),
            }).then(function (result) {
                $timeout(function () {

                    if (result.data.length > 0) {

                        $scope.DynamicGrid2BLDetails = result.data;
                    }


                });
            }, function (result) {

                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            });
        }

        $scope.back = function () {
            window.location = "/VesVoy/VoyageLockingView";
        }
        $scope.CheckBoxHeadChecked = function (checked) {

            for (var i = 0; i < $scope.DynamicGridBLDetails.length; i++) {

                $scope.DynamicGridBLDetails[i].ChkFlag = checked;

            }
        };
       

        $scope.VoyageLock = function (DynamicGridBLDetails) {

            var validation = "";

            var IntRow = 0;
            for (var i = 0; i < DynamicGridBLDetails.length; i++) {

                if (DynamicGridBLDetails[i].ChkFlag == 1) {
                    IntRow = true;
                    break;

                }
                else {

                    IntRow = false;
                }

            }
            if (IntRow == false) {
                validation += "<span style='color:red;'>*</span> <span>Please Check Atleast One BL </span></br>"
            }
            if (validation != "") {

                ShowPopup(validation);
                return false;
            }
            var BussData = {}
            BussData.VesselID = $('#ddlVoyage').val();
            BussData.ETD = $('#txtETD').val();
            BussData.UserID = localStorage.getItem("UserID");
            BussData.GeoLocID = localStorage.getItem("GeoLocationID");
            BussData.AgencyID = localStorage.getItem("AgencyID");
            var Items = []

            for (var i = 0; i < $scope.DynamicGridBLDetails.length; i++)
            {
                if ($scope.DynamicGridBLDetails[i].ChkFlag == 1)
                {
                    var TSPortv = 0;
                    if ($scope.DynamicGridBLDetails[i].TSPort != "")
                        TSPortv = $scope.DynamicGridBLDetails[i].TSPort;
                    Items.push('Insert:' + $scope.DynamicGridBLDetails[i].BLID, $scope.DynamicGridBLDetails[i].BkgID, TSPortv);
                }
            }

            BussData.GridBLID = Items.toString();

            $http({
                method: 'POST',
                url: "/api/Home/VoyageLockingUpdate",
                data: JSON.stringify(BussData),
            }).then(function (result) {
                $timeout(function () {

                    if (BussData.GridBLID != "") {
                        ShowPopup("Selected BL Locked");
                    }
                    else {

                        ShowPopup("Error Not Locked");
                    }
                    var url = "/VesVoy/VoyageLockingView";
                    window.location.href = url;
                    setTimeOut(function () {
                        window.location = "/";
                    }, 3000);
                });
            }, function (result) {
                if (result.status == 500) {
                    ShowPopup("Sorry no internet connectivity Application Error.");
                }
                else if (result.status == 404) {
                    ShowPopup("Sorry no internet connectivity page not found.");
                }


                if (result.status > 0) {
                    var errorMsg = result.status + ': ' + result.data;
                    // $(".modal").hide();
                    ShowPopup("Sorry no internet connectivity detected.Please reconnect and try  again.");
                }
            }).catch(function (result) {
                // This is set in the event of an error.
                console.log(result);
                ShowPopup('There has been an error: ' + result);
            });

        }
    });

    function ShowPopup(message) {
        swal(message);
    };


</script>
<div ng-app="MyApp" ng-controller="MyController">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12 backbtn" style="text-align:right;">
                <button type="submit" ng-click="back();" class="btn btn-fill btn-success btn-round btntop">
                    <i class="material-icons">reply</i> Back

                </button>
                @*<button type="submit" ng-click="AddNew();" class="btn btn-fill btn-warning btn-round btntop">
                        <i class="material-icons">edit</i>

                    </button>*@
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div class="card ">
                    <div class="card-header card-header-primary card-header-text">
                        <div class="card-text">
                            <h4 class="card-title"> Voyage Locking</h4>
                        </div>
                    </div>
                    <div class="card-body ">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label>Voyage</label>
                                            <select id="ddlVoyage" ng-model="ddlVoyage" class="form-control my-select" ng-options="item.VesVoy for item in VesVoy track by item.ID"></select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="lable-fond">ETD</label>
                                            <input type="date" id="txtETD" ng-model="txtETD" class="form-control" />
                                        </div>

                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <label class="lable-fond">Status</label>
                                            <input disabled type="text" id="txtStatus" ng-model="txtStatus" class="form-control" />
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="col-md-12">
                                <h4 style="color: #12759a;font-size:14px;font-weight:bold;">Un Locked BL'S</h4>
                            </div>

                            <div class="col-md-12">


                                <div class="material-datatables" id="IsVisbleGrid1" style="border: 1px solid #ccc; padding: 5px; overflow:scroll;height:200px;">

                                    <table class="table table-striped table-no-bordered table-hover" cellspacing="0" width="100%" style="width:100%">


                                        <thead>
                                            <tr>
                                                <th><input type="checkbox" ng-change="CheckBoxHeadChecked(BLHDCheck);" ng-true-value="1" ng-false-value="0" ng-model="BLHDCheck" id="BLHDCheck" />  </th>
                                                <th>BL Number</th>
                                                <th>POL</th>
                                                <th>POD</th>
                                                <th>T/S PORT</th>
                                                <th>BL Release Status </th>
                                                <th>Container No</th>
                                                <th>Status Code</th>
                                            </tr>
                                        </thead>
                                        <tbody>

                                            <tr ng-repeat="gRow in DynamicGridBLDetails">
                                                <td> <input ng-change="CheckBoxValid(gRow.DynamicGridBLDetails);" type="checkbox" id="ChkFlag" value="{{gRow.BLID}}" ng-model="gRow.ChkFlag" ng-true-value="1" ng-false-value="0" /></td>

                                                <td>
                                                    {{gRow.BLNumber}}

                                                    <input type="hidden" id="HDBLID" class="form-control" ng-model="gRow.BLID" />
                                                </td>

                                                <td>{{gRow.POL}}</td>
                                                <td>{{gRow.POD}}</td>
                                                <td>{{gRow.TSPort}}</td>
                                                <td>{{gRow.StatusV}}</td>
                                                <td style="width:0;">{{gRow.CntrNo}} </td>
                                                <td>{{gRow.CntrStatusCodev}} </td>


                                            </tr>


                                        </tbody>
                                    </table>


                                </div>
                                <div class="row">

                                    <div class="col-md-12">
                                        <h4 style="color: #12759a;font-size:14px;font-weight:bold;">Locked BL'S</h4>
                                    </div>
                                    <div class="col-md-12">
                                        <div class="material-datatables" id="IsVisbleGrid2" style="border: 1px solid #ccc; padding: 5px; overflow:scroll;height:200px;">

                                            <table class="table table-striped table-no-bordered table-hover" cellspacing="0" width="100%" style="width:100%">


                                                <thead>
                                                    <tr>

                                                        <th>BL Number</th>
                                                        <th>POL</th>
                                                        <th>POD</th>
                                                        <th>T/S PORT</th>
                                                        <th>BL Release Status </th>
                                                        <th>Container No</th>
                                                        <th>Status Code</th>

                                                    </tr>
                                                </thead>
                                                <tbody>

                                                    <tr ng-repeat="i in DynamicGrid2BLDetails">


                                                        <td>
                                                            {{i.BLNumber}}

                                                            <input type="hidden" id="HDBLID" class="form-control" ng-model="i.BLID" />
                                                        </td>

                                                        <td>{{i.POL}}</td>
                                                        <td>{{i.POD}}</td>
                                                        <td>{{i.TSPort}}</td>
                                                        <td>{{i.StatusV}}</td>
                                                        <td style="width:0;">{{i.CntrNo}}                                </td>
                                                        <td>{{i.CntrStatusCodev}} </td>


                                                    </tr>


                                                </tbody>
                                            </table>


                                        </div>
                                    </div>


                                </div>

                            </div>
                        </div>
                    </div>

                    <div class="card-footer ">
                        <div class="col-md-12" style="text-align:right;">
                            <button type="submit" id="BtnLock" ng-click="VoyageLock(DynamicGridBLDetails);" class="btn btn-fill btn-success">Lock</button>
                            <input type="hidden" id="HdVoyId" ng-model="HdVoyId" />
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            // initialise Datetimepicker and Sliders
            $('.datepicker').datetimepicker({
                format: 'DD/MM/YYYY',

            });
        });
    </script>
